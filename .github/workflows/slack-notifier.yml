name: Slack Notifier
on:
  workflow_run:
    workflows: [Dev - Build and Test]
    types: [completed]

jobs:
  on-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure' || github.event.workflow_run.conclusion == 'timed_out'
    steps:
      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
          COMMITTER_NAME: ${{github.event.workflow_run.head_commit.committer.name}}
          COMMIT_MESSAGE: ${{github.event.workflow_run.head_commit.message}}
          WORKFLOW_CONCLUSION: ${{github.event.workflow_run.conclusion}}
          WORKFLOW_NAME: ${{github.event.workflow_run.name}}
        run: |
          workflow=${{github.event.workflow_run.name}}
          result=${{github.event.workflow_run.conclusion}}
          user=${{github.event.workflow_run.head_commit.committer.name}}
          message=${{github.event.workflow_run.head_commit.message}}
          runUrl=${{github.server_url}}/${{github.repository}}/actions/runs/${{github.event.workflow_run.id}}
          echo Workflow $workflow result was [$result]. Triggered by $user with $message. Run details: $runUrl
        
# curl -X POST -H 'Content-type: application/json' --data '{"text":"GitHub job failure: <${{github.server_url}}/${{github.repository}}/actions/runs/${{github.event.workflow_run.id}}|View Failure>"}'  

      # - uses: ravsamhq/notify-slack-action@v2
      #   with:
      #     status: ${{ github.event.workflow_run.conclusion }}
      #     notification_title: " ${{github.event.workflow_run.name}} - ${{github.event.workflow_run.conclusion}} on ${{github.event.workflow_run.head_branch}} - <${{github.server_url}}/${{github.repository}}/actions/runs/${{github.event.workflow_run.id}}|View Failure>"
      #     message_format: ":fire: *${{github.event.workflow_run.name}}* ${{github.event.workflow_run.conclusion}} in <${{github.server_url}}/${{github.repository}}/${{github.event.workflow_run.head_branch}}|${{github.repository}}>"
      #     footer: "Linked Repo <${{github.server_url}}/${{github.repository}}|${{github.repository}}> | <${{github.server_url}}/${{github.repository}}/actions/runs/${{github.event.workflow_run.id}}|View Failure>"
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.MASTER_PROD_FAIL_SLACK }}